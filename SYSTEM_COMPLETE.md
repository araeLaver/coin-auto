# ✅ 완전 작동 시스템 - 최종 가이드

## 🎉 시스템 완성!

**이제 실제로 작동하는 완전한 자동매매 시스템입니다.**

### 🔥 주요 개선사항

#### V1 → V2 업그레이드

**문제점:**
- ❌ 데이터 수집과 트레이딩이 분리됨
- ❌ 시그널은 생성되지만 실제 매매 안됨
- ❌ 포지션 관리가 작동하지 않음
- ❌ 매도 로직 누락

**해결책:**
- ✅ **TradingEngineV2** - 완전 통합 엔진
- ✅ 백그라운드 데이터 수집 (멀티스레드)
- ✅ 실시간 시그널 생성 및 실행
- ✅ 자동 포지션 관리 (손절/익절)
- ✅ 매수/매도 완전 자동화
- ✅ 텔레그램 실시간 알림
- ✅ 에러 복구 로직

## 🚀 빠른 시작 (3단계)

### 1단계: 데이터베이스 초기화

```bash
python main.py --mode init
```

**출력 예시:**
```
✓ 스키마 생성 완료
✓ 전략 생성: Trend Following
✓ 전략 생성: Mean Reversion
✓ 전략 생성: Momentum Breakout
✓ 전략 생성: Orderbook Imbalance
```

### 2단계: 시스템 테스트

```bash
python test_system.py
```

**출력 예시:**
```
[1/10] 데이터베이스 연결 테스트...
  ✓ 데이터베이스 연결 성공

[2/10] 빗썸 API 연결 테스트...
  ✓ API 연결 성공
  ✓ BTC 현재가: 85,000,000원

...

총 10/10 테스트 통과
✅ 모든 테스트 통과! 시스템 정상 작동 준비 완료
```

### 3단계: 트레이딩 시작

```bash
python main.py --mode run --interval 60
```

**실행 화면:**
```
==================================================
Auto Coin Trading V2 시작
모드: 페이퍼
대상: BTC, ETH, XRP, ADA, SOL
주기: 60초
==================================================

초기 데이터 수집 중... (30초)

==================================================
[사이클 #1] 2025-01-15 10:30:00
==================================================

[BTC] 현재가: 85,000,000원
  시그널 2개 생성
  최적 시그널: BUY (전략: Trend Following, 신뢰도: 75.0%)
  포지션 크기: 100,000원
  ✓ 포지션 오픈 성공: 1
```

## 📊 시스템 작동 흐름

### 실시간 프로세스

```
┌─────────────────────────────────────────────┐
│    백그라운드 데이터 수집 (항상 실행)          │
├─────────────────────────────────────────────┤
│  Thread 1: 가격 데이터 (5초마다)             │
│  Thread 2: 호가창 데이터 (1초마다)           │
│  Thread 3: 기술적 지표 (60초마다)            │
└─────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────┐
│         메인 트레이딩 루프 (60초마다)          │
├─────────────────────────────────────────────┤
│  1. 현재가 확인                               │
│  2. 기존 포지션 관리 (자동 손절/익절)          │
│  3. 리스크 체크                               │
│  4. 시그널 생성 (4개 전략)                    │
│  5. 최적 시그널 선택                          │
│  6. 리스크 검증                               │
│  7. 주문 실행 (BUY만)                        │
│  8. 텔레그램 알림                             │
└─────────────────────────────────────────────┘
```

### 자동 매도 로직

**포지션 오픈 후 자동으로:**
1. 익절가 도달 → 자동 매도
2. 손절가 도달 → 자동 매도
3. 수익 5% 이상 → 트레일링 스톱 (손절가 상향)
4. 24시간 보유 + 손실 → 자동 매도

## 🎯 실제 사용 시나리오

### 시나리오 1: 추세 추종 매매

```
10:00 - [BTC] 현재가: 85,000,000원
      - Trend Following 전략 시그널: BUY
      - 진입가: 85,000,000원
      - 손절가: 83,300,000원 (-2%)
      - 익절가: 89,250,000원 (+5%)
      → 포지션 오픈

10:30 - [BTC] 현재가: 87,000,000원
      - 수익: +2.35%
      → 포지션 유지

11:00 - [BTC] 현재가: 89,300,000원
      - 익절가 도달!
      → 자동 매도
      → 수익: +5.06%
      → 텔레그램 알림 전송
```

### 시나리오 2: 손절

```
10:00 - [ETH] 진입가: 4,500,000원
      - 손절가: 4,410,000원

10:15 - [ETH] 현재가: 4,400,000원
      - 손절가 도달!
      → 자동 매도
      → 손실: -2.22%
      → 추가 손실 방지
```

### 시나리오 3: 일일 손실 한도

```
하루 총 5건 거래
- 거래 1: -2%
- 거래 2: -1.5%
- 거래 3: -1.8%
→ 누적 손실: -5.3%

⚠️ 일일 손실 한도 (5%) 초과
→ 당일 거래 자동 중단
→ 텔레그램 알림
→ 내일 0시 자동 재개
```

## 📱 텔레그램 알림 예시

### 포지션 오픈
```
🟢 포지션 오픈

💰 코인: BTC
📊 방향: LONG
💵 진입가: 85,000,000원
📦 수량: 0.00117647 BTC
💸 투자금: 100,000원

🎯 익절가: 89,250,000원
🛡 손절가: 83,300,000원

📈 전략: Trend Following
🔍 신뢰도: 75.0%
```

### 포지션 청산
```
🟢 포지션 청산

💰 코인: BTC
📊 방향: LONG
💵 진입가: 85,000,000원
💵 청산가: 89,300,000원

💰 손익: +5,060원 (+5.06%)

⏱ 보유시간: 1.0시간
📝 청산이유: TAKE_PROFIT
```

## ⚙️ 설정 커스터마이징

### `.env` 파일 수정

```bash
# 거래 설정
TRADE_MODE=paper              # paper: 모의, live: 실전
INITIAL_CAPITAL=1000000       # 초기 자본 100만원
MAX_POSITION_SIZE=0.1         # 한 번에 10%만 투자
MAX_OPEN_POSITIONS=3          # 최대 3개 동시 보유

# 리스크 관리
STOP_LOSS_PERCENT=0.02        # 2% 손절
TAKE_PROFIT_PERCENT=0.05      # 5% 익절
MAX_DAILY_LOSS=0.05           # 일일 최대 5% 손실
```

### `config.py` 수정

```python
# 거래할 코인 변경
TARGET_PAIRS = [
    'BTC',   # 비트코인
    'ETH',   # 이더리움
]

# 데이터 수집 주기 조정
ORDERBOOK_INTERVAL = 1   # 호가창: 1초
PRICE_INTERVAL = 5       # 가격: 5초
INDICATOR_INTERVAL = 60  # 지표: 60초
```

## 🔍 모니터링

### 실시간 로그

```bash
# 실행 중 화면에 표시됨
[BTC] 현재가: 85,000,000원
  시그널 2개 생성
  최적 시그널: BUY
  포지션 크기: 100,000원
  ✓ 포지션 오픈 성공

[ETH] 현재가: 4,500,000원
  ✓ 포지션 청산: ETH (이유: TAKE_PROFIT)
```

### 데이터베이스 확인

```sql
-- 오늘의 거래
SELECT
    symbol,
    entry_price,
    exit_price,
    pnl,
    pnl_percent,
    exit_reason
FROM auto_coin_trading.trades
WHERE closed_at >= CURRENT_DATE
ORDER BY closed_at DESC;

-- 현재 포지션
SELECT * FROM auto_coin_trading.v_active_positions;

-- 일일 성과
SELECT * FROM auto_coin_trading.daily_performance
WHERE date = CURRENT_DATE;
```

## 🐛 문제 해결

### 문제 1: "데이터 부족" 메시지

**원인:** 기술적 지표 계산에 필요한 과거 데이터 없음

**해결:**
```bash
# 30분 정도 데이터 수집
python main.py --mode collect

# 30분 후 Ctrl+C로 중단하고 다시 실행
python main.py --mode run
```

### 문제 2: 시그널은 생성되는데 매매가 안됨

**원인:** 리스크 검증 실패 (잔고 부족, 손실 한도 등)

**확인:**
- 페이퍼 모드에서 INITIAL_CAPITAL 확인
- 일일 손실 한도 초과 여부 확인

### 문제 3: 텔레그램 알림 안옴

**원인:** 봇 토큰 또는 Chat ID 미설정

**해결:**
```bash
# .env 파일 확인
TELEGRAM_BOT_TOKEN=your_actual_token
TELEGRAM_CHAT_ID=your_actual_chat_id

# 테스트
python -c "from utils.telegram_notifier import TelegramNotifier; TelegramNotifier().send_message('테스트')"
```

## 📈 성과 분석

### 1주일 후 체크할 것

```sql
-- 전략별 성과
SELECT * FROM auto_coin_trading.v_strategy_summary;

-- 승률
SELECT
    COUNT(*) as total_trades,
    SUM(CASE WHEN pnl > 0 THEN 1 ELSE 0 END) as wins,
    ROUND(SUM(CASE WHEN pnl > 0 THEN 1.0 ELSE 0.0 END) / COUNT(*) * 100, 2) as win_rate
FROM auto_coin_trading.trades;

-- 총 손익
SELECT SUM(pnl) as total_pnl
FROM auto_coin_trading.trades;
```

## ⚠️ 실전 전 체크리스트

- [ ] 1주일 페이퍼 트레이딩 완료
- [ ] 승률 55% 이상
- [ ] 시스템 안정성 확인 (에러 없이 24시간 작동)
- [ ] 빗썸 API Key 발급 및 `.env` 설정
- [ ] `.env`에서 `TRADE_MODE=live`로 변경
- [ ] 소액 (10만원 이하) 실전 테스트
- [ ] 텔레그램 알림 정상 작동 확인

## 🎓 시스템 아키텍처 요약

```
TradingEngineV2 (메인)
    ├── 백그라운드 스레드
    │   ├── 가격 수집 (5초)
    │   ├── 호가창 수집 (1초)
    │   └── 지표 계산 (60초)
    │
    ├── 메인 루프 (60초)
    │   ├── 포지션 관리 (자동 손절/익절)
    │   ├── 시그널 생성 (4개 전략)
    │   ├── 리스크 검증
    │   └── 주문 실행
    │
    ├── RiskManager
    │   ├── 일일 손실 한도
    │   ├── 포지션 수 제한
    │   ├── 포지션 크기 계산
    │   └── 손절/익절 판단
    │
    ├── OrderExecutor
    │   ├── 주문 실행 (BUY)
    │   ├── 포지션 청산 (SELL)
    │   └── 잔고 관리
    │
    └── TelegramNotifier
        ├── 포지션 오픈 알림
        ├── 포지션 청산 알림
        └── 리스크 경고 알림
```

## 🚀 배포하기

```bash
# 1. 커밋
git add .
git commit -m "Complete working trading system V2"

# 2. GitHub 푸시
git push origin main

# 3. Koyeb 배포 (DEPLOYMENT.md 참고)
```

## 📞 지원

문제 발생 시:
1. `test_system.py` 실행으로 문제 파악
2. 로그 확인
3. GitHub Issues 생성

---

**축하합니다! 이제 완전히 작동하는 자동매매 시스템을 갖게 되었습니다!** 🎉

**시작 명령어:**
```bash
python main.py --mode run --interval 60
```

**절대 잊지 마세요:**
- 페이퍼 모드로 충분히 테스트
- 소액부터 시작
- 리스크 관리 필수
